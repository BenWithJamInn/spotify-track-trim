!async function(){for(;!Spicetify.React||!Spicetify.ReactDOM;)await new Promise(t=>setTimeout(t,10));var t,e,s,l,c,m,d,u,i,r,p,a,f,n,g,h,o,y,v,S,b,w,T,O,k,C,E,R,P,B,x,L,N,I,M,X;s=Object.create,l=Object.defineProperty,c=Object.getOwnPropertyDescriptor,m=Object.getOwnPropertyNames,d=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty,t={"external-global-plugin:react"(t,e){e.exports=Spicetify.React}},p=(i=(t,e,i)=>{i=null!=t?s(d(t)):{};var r=!e&&t&&t.__esModule?i:l(i,"default",{value:t,enumerable:!0}),a=t,n=void 0,o=void 0;if(a&&"object"==typeof a||"function"==typeof a)for(let t of m(a))u.call(r,t)||t===n||l(r,t,{get:()=>a[t],enumerable:!(o=c(a,t))||o.enumerable});return r})((r=function(){return e||(0,t[m(t)[0]])((e={exports:{}}).exports,e),e.exports})()),a=i(r()),f=i(r(),1),i=i(r(),1),n={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},g=i.default.createContext&&i.default.createContext(n),h=["attr","size","title"],o=()=>Spicetify.Player.data.item.uid,y=()=>Spicetify.Player.data.item.duration.milliseconds,v=()=>a.default.createElement(Spicetify.ReactComponent.Menu,null,a.default.createElement(Spicetify.ReactComponent.MenuItem,{onClick:()=>{I.removeAllTrims(o())},leadingIcon:a.default.createElement(J,{size:22})},a.default.createElement(Spicetify.ReactComponent.TextComponent,{semanticColor:"textBase",variant:"viola",weight:"book"},"Remove All Trims")),a.default.createElement(Spicetify.ReactComponent.MenuItem,{onClick:()=>{var t,e=y()*I.getProgressFromX(I.lastX);for(t of I.getTrims(o()))if(t.isTimestampWithinTrim(e))return void Spicetify.showNotification("Cannot add a new trim within an existing trim!",!0);var i=I.getNextTimestampJump(o(),e,y(),"left");I.newTrim(o(),i,e),I.renderTrims(o())},leadingIcon:a.default.createElement(A,{size:20})},a.default.createElement(Spicetify.ReactComponent.TextComponent,{semanticColor:"textBase",variant:"viola",weight:"book"},"Trim Left")),a.default.createElement(Spicetify.ReactComponent.MenuItem,{onClick:()=>{var t,e=y()*I.getProgressFromX(I.lastX);for(t of I.getTrims(o()))if(t.isTimestampWithinTrim(e))return void Spicetify.showNotification("Cannot add a new trim within an existing trim!",!0);var i=I.getNextTimestampJump(o(),e,y(),"right");I.newTrim(o(),e,i),I.renderTrims(o())},leadingIcon:a.default.createElement(U,{size:20})},a.default.createElement(Spicetify.ReactComponent.TextComponent,{semanticColor:"textBase",variant:"viola",weight:"book"},"Trim Right"))),S=()=>a.default.createElement(Spicetify.ReactComponent.RemoteConfigProvider,{configuration:Spicetify.Platform.RemoteConfiguration},a.default.createElement(Spicetify.ReactComponent.RightClickMenu,{menu:a.default.createElement(v,null)},a.default.createElement("div",{style:{width:"100%",height:"100%",position:"absolute",zIndex:"101"}}))),b=Spicetify.React,w=()=>Spicetify.Player.data.item.duration.milliseconds,T=()=>Spicetify.Player.data.item.uid,O=()=>b.createElement("div",{style:{width:"100%",height:"100%"}},b.createElement(S,null)),k=()=>{let[e,i]=b.useState({trims:[],reID:0});return(0,p.useEffect)(()=>{I.updateActiveTrims=t=>{i({trims:t,reID:e.reID+1})}},[]),b.createElement(Spicetify.ReactComponent.RemoteConfigProvider,{configuration:Spicetify.Platform.RemoteConfiguration},b.createElement("div",{style:{width:"100%",height:"100%",position:"absolute",display:"flex",alignItems:"center"}},e.trims.map((t,e)=>b.createElement(C,{trim:t}))))},C=t=>{let[e,r]=(0,p.useState)({trim:t.trim,reID:0});function i(e,i){r(t=>("left"===e?t.trim.trimLeft=i:t.trim.trimRight=i,{trim:t.trim,reID:t.reID+1}))}return b.createElement(b.Fragment,null,b.createElement(E,{direction:"left",timestamp:e.trim.trimRight,trim:e.trim,updateTimestamp:t=>i("right",t)}),b.createElement(E,{direction:"right",timestamp:e.trim.trimLeft,trim:e.trim,updateTimestamp:t=>i("left",t)}),b.createElement(P,{start:e.trim.trimLeft,end:e.trim.trimRight}))},E=r=>{let[t,e]=(0,p.useState)(!1),[a,n]=(0,p.useState)(!1);var i=t||a,i="left"===r.direction?b.createElement(A,{size:i?22:20,color:i?"white":""}):b.createElement(U,{size:i?22:20,color:i?"white":""}),o=I.getRelativeXFromProgress(r.timestamp/w())-("left"===r.direction?7:15);return(0,p.useEffect)(()=>{let i="left"===r.direction?r.trim.trimLeft:r.trim.trimRight,t=e=>{if(a){e=e.clientX,e=Math.min(w(),Math.max(0,I.getProgressFromX(e)));let t=w()*e;e=I.getNextTimestampJump(T(),i,w(),"left"===r.direction?"right":"left",r.trim.trimID);t="left"===r.direction?Math.max(Math.min(e,t),i+2e3):Math.min(Math.max(e,t),i-2e3),r.updateTimestamp(t)}},e=()=>{a&&n(!1)};return document.body.addEventListener("mousemove",t),document.body.addEventListener("mouseup",e),()=>{document.body.removeEventListener("mousemove",t),document.body.removeEventListener("mouseup",e)}},[a]),b.createElement("div",{style:{position:"absolute",left:o,display:"flex",alignItems:"center",justifyContent:"center",zIndex:"999",height:"22px",width:"22px"},onMouseEnter:t=>{e(!0)},onMouseLeave:t=>{e(!1)},onMouseDown:t=>{n(!0)}},b.createElement(Spicetify.ReactComponent.RightClickMenu,{menu:b.createElement(R,{trimID:r.trim.trimID})},i))},R=t=>b.createElement(Spicetify.ReactComponent.Menu,null,b.createElement(Spicetify.ReactComponent.MenuItem,{onClick:()=>{I.removeTrim(T(),t.trimID)},leadingIcon:b.createElement(J,{size:22})},b.createElement(Spicetify.ReactComponent.TextComponent,{semanticColor:"textBase",variant:"viola",weight:"book"},"Remove Trim"))),P=t=>{var e=I.getRelativeXFromProgress(t.start/w()),t=I.getRelativeXFromProgress(t.end/w())-e,i=document.querySelector(".x-progressBar-progressBarBg").clientHeight+1;return b.createElement("div",{style:{position:"absolute",backgroundColor:"rgb(160,0,0)",margin:"auto",height:i+"px",width:t+"px ",left:e+"px"}})},B=()=>{var t=new Spicetify.Menu.Item("Import",!1,()=>{I.importTrims()}),e=new Spicetify.Menu.Item("Export",!1,()=>{I.exportTrims()});new Spicetify.Menu.SubMenu("Track Trim",[e,t]).register()},x=Spicetify.ReactDOM,L=Spicetify.React,(I=N=class{static init(){this._barOverlay.addEventListener("contextmenu",t=>{this._lastX=t.clientX}),visualViewport.addEventListener("resize",()=>{this.renderTrims(Spicetify.Player.data.item.uid)}),Spicetify.Player.addEventListener("songchange",()=>{N.renderTrims(Spicetify.Player.data.item.uid)}),Spicetify.Player.addEventListener("onprogress",t=>{var e,i,r,a;0<this.handlingCooldown?this.handlingCooldown--:(e=Spicetify.Player.getProgress(),i=Spicetify.Player.data.item.duration.milliseconds,r=Spicetify.Player.data.item.uid,null!=(a=this.getIntersectingTrim(r,e))&&(a.incrementSkipCount(),this.handlingCooldown=15,(a=this.resolveSongSeek(r,e,i,2!=Spicetify.Player.getRepeat()))==i?Spicetify.Player.next():Spicetify.Player.seek(a)))}),B()}static newTrim(t,e,i){if(i<e)throw new Error("Left trim cannot be greater than right trim");this.trims[t]||(this.trims[t]=[]);e=M.new(t,e,i);this.trims[t].push(e),e.save()}static removeTrim(t,e){this.trims[t]&&(this.trims[t]=this.trims[t].filter(t=>t.trimID!==e));var i=this.getSavedSong(t);delete i.trims[e],this.saveSong(i),this.renderTrims(t)}static removeAllTrims(t){this.trims[t]&&(this.trims[t]=[]);var e=this.getSavedSong(t);e.trims={},this.saveSong(e),this.renderTrims(t)}static getTrims(i){var t=this.trims[i];if(t)return t;let r=[];return Object.entries(this.getSavedSong(i).trims).forEach(([t,e])=>{r.push(new M(t,i,e.dateCreated,e.dateLastUpdated,e.skipCount,e.trimLeft,e.trimRight))}),r}static getSavedSong(t){var e=Spicetify.LocalStorage.get("track-trim:trims:"+t);return e?JSON.parse(e):{id:t,dateCreated:e=(new Date).toISOString(),dateLastUpdated:e,trims:{}}}static saveSong(t){var e=JSON.stringify(t);Spicetify.LocalStorage.set("track-trim:trims:"+t.id,e)}static renderTrims(t){this._updateActiveTrims&&this._updateActiveTrims(this.getTrims(t)||[])}static getProgressFromX(t){var e=this.barOverlay.getBoundingClientRect();return t<e.left?0:t>e.right?1:(t-e.x)/e.width}static getRelativeXFromProgress(t){return this.barOverlay.getBoundingClientRect().width*t}static getNextTimestampJump(t,e,i,r,a=null){var n=this.getTrims(t)||[],o="left"===r;if(0==n.length&&o)return 0;let s=o?0:i;for(let t=n.length-1;0<=t;t--)n[t].trimID!==a&&(o?n[t].trimRight<e&&(s=Math.max(s,n[t].trimRight)):n[t].trimLeft>e&&(s=Math.min(s,n[t].trimLeft)));t=Math.min(.05*i,Math.abs(s-e));return 0!=s&&s!=i&&(o?s+=t:s-=t),s}static getIntersectingTrim(t,e){var i;for(i of this.getTrims(t)||[])if(i.isTimestampWithinTrim(e))return i;return null}static resolveSongSeek(t,e,i,r){var a;for(a of this.getTrims(t)||[])if(a.isTimestampWithinTrim(e))return i-a.trimRight<=1e3&&!r?this.resolveSongSeek(t,0,i,!0)+1e3:a.trimRight+1e3>=i?i:a.trimRight+1e3;return e}static exportTrims(){var t,e,i={date:(new Date).toISOString(),songs:[]};for(t in localStorage)t.startsWith("track-trim:trims:")&&(e=t.replace("track-trim:trims:",""),e=this.getSavedSong(e),i.songs.push(e));var r=JSON.stringify(i),r=new Blob([r],{type:"application/json"}),r=URL.createObjectURL(r),a=document.createElement("a");a.href=r,a.download="track-trim-export.json",a.target="_blank",a.click(),Spicetify.showNotification("Trims exported to your downloads folder as track-trim-export.json!")}static async importTrims(){let e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async()=>{if(e.files&&0!=e.files.length){var t=e.files[0];let o=new FileReader;o.onload=async()=>{var t,e=[];for(t of JSON.parse(o.result).songs)e.push(t.id),delete this.trims[t.id],this.saveSong(t),console.log("Imported song",t.id);var i,r,a,n=[];for(i in localStorage)i.startsWith("track-trim:trims:")&&(r=i.replace("track-trim:trims:",""),e.includes(r)||n.push(i));for(a of n)Spicetify.LocalStorage.remove(a);Spicetify.showNotification("Trims imported!"),this.renderTrims(Spicetify.Player.data.item.uid)},o.readAsText(t)}},e.click()}static get barOverlay(){return this._barOverlay}static get lastX(){return this._lastX}static get internalProgressBar(){return this._internalProgressBar}static set internalProgressBar(t){this._internalProgressBar=t}static set updateActiveTrims(t){this._updateActiveTrims=t}}).trims={},I._updateActiveTrims=null,I._barOverlay=document.createElement("div"),I.dragBlock=document.createElement("div"),I._lastX=0,I.handlingCooldown=0,M=class{constructor(t,e,i,r,a,n,o){this.trimID=t,this.songID=e,this._dateCreated=i,this._dateLastUpdated=r,this._skipCount=a,this._trimLeft=n,this._trimRight=o}static new(t,e,i){return new M(Math.random().toString(36).substring(7),t,(new Date).toISOString(),(new Date).toISOString(),0,e,i)}isTimestampWithinTrim(t){return t>=this.trimLeft&&t<=this.trimRight}toData(){return{dateCreated:this._dateCreated,dateLastUpdated:this._dateLastUpdated,trimLeft:this._trimLeft,trimRight:this._trimRight,skipCount:this._skipCount}}save(){var t=I.getSavedSong(this.songID),e=(new Date).toISOString();t.dateLastUpdated=e,this._dateLastUpdated=e,t.trims[this.trimID]=this.toData(),I.saveSong(t)}incrementSkipCount(){this._skipCount++,this.save()}get trimLeft(){return this._trimLeft}get trimRight(){return this._trimRight}set trimLeft(t){this._trimLeft=t,this.save()}set trimRight(t){this._trimRight=t,this.save()}},X=async function t(){if(Spicetify.Player&&Spicetify.React&&Spicetify.ReactDOM&&Spicetify.ReactComponent&&Spicetify.showNotification){var e=document.querySelector(".progress-bar"),i=document.querySelector(".playback-progressbar-container");if(e&&i){I.barOverlay.id="playback-bar-overlap",I.barOverlay.style.position="absolute",I.barOverlay.style.width="100%",I.barOverlay.style.height="100%",e.style.position="relative",e.append(I.barOverlay),I.internalProgressBar=e,I.dragBlock.id="playback-bar-drag-block",I.dragBlock.style.position="absolute",I.dragBlock.style.width="100%",I.dragBlock.style.height="100%",i.style.position="relative",i.append(I.dragBlock),(async()=>x.render(L.createElement(O,null),I.barOverlay))(),(async()=>x.render(L.createElement(k,null),I.dragBlock))(),I.init();let t=setInterval(()=>{Spicetify.Player.data.item&&(I.renderTrims(Spicetify.Player.data.item.uid),clearInterval(t))},1e3)}else Spicetify.showNotification("Failed to load track-trim: Playback bar not found!")}else setTimeout(t,10)},(async()=>{await X()})();function z(t,e){if(null==t)return{};var i,r=function(t,e){if(null==t)return{};var i,r={};for(i in t)!Object.prototype.hasOwnProperty.call(t,i)||0<=e.indexOf(i)||(r[i]=t[i]);return r}(t,e);if(Object.getOwnPropertySymbols)for(var a=Object.getOwnPropertySymbols(t),n=0;n<a.length;n++)i=a[n],0<=e.indexOf(i)||Object.prototype.propertyIsEnumerable.call(t,i)&&(r[i]=t[i]);return r}function j(){return(j=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var i,r=arguments[e];for(i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t}).apply(this,arguments)}function F(e,t){var i,r=Object.keys(e);return Object.getOwnPropertySymbols&&(i=Object.getOwnPropertySymbols(e),t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,i)),r}function D(r){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?F(Object(a),!0).forEach(function(t){var e,i;e=r,i=a[t=t],(t=function(t){t=function(t,e){if("object"!=typeof t||!t)return t;var i=t[Symbol.toPrimitive];if(void 0===i)return("string"===e?String:Number)(t);i=i.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}(t,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(a)):F(Object(a)).forEach(function(t){Object.defineProperty(r,t,Object.getOwnPropertyDescriptor(a,t))})}return r}function _(e){return t=>f.default.createElement(W,j({attr:D({},e.attr)},t),function i(t){return t&&t.map((t,e)=>f.default.createElement(t.tag,D({key:e},t.attr),i(t.child)))}(e.child))}function W(o){var e=t=>{var e,{attr:i,size:r,title:a}=o,n=z(o,h),r=r||t.size||"1em";return t.className&&(e=t.className),o.className&&(e=(e?e+" ":"")+o.className),f.default.createElement("svg",j({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},t.attr,i,n,{className:e,style:D(D({color:o.color||t.color},t.style),o.style),height:r,width:r,xmlns:"http://www.w3.org/2000/svg"}),a&&f.default.createElement("title",null,a),o.children)};return void 0!==g?f.default.createElement(g.Consumer,null,t=>e(t)):e(n)}function A(t){return _({tag:"svg",attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M7 6v12"},child:[]},{tag:"path",attr:{d:"M18 6l-6 6l6 6"},child:[]}]})(t)}function U(t){return _({tag:"svg",attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M6 6l6 6l-6 6"},child:[]},{tag:"path",attr:{d:"M17 5v13"},child:[]}]})(t)}function J(t){return _({tag:"svg",attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M4 7l16 0"},child:[]},{tag:"path",attr:{d:"M10 11l0 6"},child:[]},{tag:"path",attr:{d:"M14 11l0 6"},child:[]},{tag:"path",attr:{d:"M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"},child:[]},{tag:"path",attr:{d:"M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"},child:[]}]})(t)}}();